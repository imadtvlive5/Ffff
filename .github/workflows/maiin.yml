name: RDP (Self Hosted Linux)

on:
  workflow_dispatch:

jobs:
  secure-rdp:
    runs-on: [self-hosted, linux, x64]
    timeout-minutes: 0

    steps:
      - name: Update system
        shell: bash
        run: |
          sudo apt update -y

      - name: Install Desktop + XRDP
        shell: bash
        run: |
          sudo apt install -y xfce4 xfce4-goodies xrdp
          sudo systemctl enable xrdp
          sudo systemctl restart xrdp

      - name: Configure XRDP session
        shell: bash
        run: |
          echo "xfce4-session" > ~/.xsession
          sudo sed -i.bak '/fi/a \
startxfce4 \n' /etc/xrdp/startwm.sh

      - name: Create RDP User
        shell: bash
        run: |
          USERNAME=rdp
          PASSWORD='Rdp@123456'

          if ! id "$USERNAME" &>/dev/null; then
            sudo useradd -m -s /bin/bash "$USERNAME"
            echo "$USERNAME:$PASSWORD" | sudo chpasswd
            sudo usermod -aG sudo "$USERNAME"
          fi

          echo "User: $USERNAME"
          echo "Password: $PASSWORD"

      - name: Open RDP Port
        shell: bash
        run: |
          sudo ufw allow 3389/tcp || true

      - name: Keep Runner Alive
        shell: bash
        run: |
          echo "Linux RDP (XRDP) is active"
          while true; do sleep 600; done
