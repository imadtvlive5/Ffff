name: RDP (Self Hosted Linux)

on:
  workflow_dispatch:

jobs:
  secure-rdp:
    runs-on: [self-hosted, linux, x64]
    timeout-minutes: 0

    steps:
      - name: Update system
        shell: bash
        run: |
          sudo apt update -y
          sudo apt upgrade -y

      - name: Install Desktop Environment and XRDP
        shell: bash
        run: |
          sudo apt install -y xfce4 xfce4-goodies xrdp dbus-x11
          sudo systemctl enable xrdp
          sudo systemctl restart xrdp

      - name: Configure XRDP to use XFCE
        shell: bash
        run: |
          echo "xfce4-session" > /home/runner/.xsession
          sudo sed -i '/^exec /c\exec startxfce4 &' /etc/xrdp/startwm.sh

      - name: Create RDP User
        shell: bash
        run: |
          USERNAME=rdp
          PASSWORD='Rdp@123456'

          if ! id "$USERNAME" >/dev/null 2>&1; then
            sudo useradd -m -s /bin/bash "$USERNAME"
            echo "$USERNAME:$PASSWORD" | sudo chpasswd
            sudo usermod -aG sudo "$USERNAME"
          fi

          echo "=============================="
          echo "RDP USER: $USERNAME"
          echo "RDP PASS: $PASSWORD"
          echo "PORT    : 3389"
          echo "=============================="

      - name: Allow RDP Port
        shell: bash
        run: |
          sudo ufw allow 3389/tcp || true
          sudo ufw reload || true

      - name: Keep Runner Alive
        shell: bash
        run: |
          echo "XRDP is running and ready"
          while true; do sleep 600; done
